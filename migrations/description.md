# Проектная работа по DWH и пересмотру модели данных.

## Опишем целевую витрину.

Задача: Из полученных данных произвести миграцию данных в отдельные логические таблицы, а затем собрать на них витрину данных. Решение нашей задачи поможет оптимизировать нагрузку на хранилище и позволит аналитикам, перед которыми стоит задача построить анализ эффективности и прибыльности бизнеса, отвечать на точечные вопросы о тарифах вендоров, стоимости доставки в разные страны, кол-ве доставленных заказов за последнюю неделю.

Исходная таблица - public.shipping, которая представляет собой последовательность действий при доставке:
- id — уникальный идентификатор записи в таблице;
- shipping_id — уникальный идентификатор доставки;
- sale_id — уникальный идентификатор продажи. К одной продаже может быть привязано несколько строчек shipping_id, то есть логов, с информацией о доставке;
- order_id — уникальный идентификатор заказа;
- client_id — уникальный идентификатор клиента;
- payment_amount — сумма платежа (то есть дублирующаяся информация);
- state_datetime — время обновления состояния заказа;
- product_id — уникальный идентификатор товара;
- description — полное описание товара;
- vendor_id — уникальный идентификатор вендора. К одному вендору может быть привязано множество sale_id и множество строк доставки;
- name_category — название категории товара;
- base_country — страна производитель;
- status - статус доставки в таблице shipping по данному shipping_id. Может принимать значения in_progress — доставка в процессе, либо finished — доставка завершена;
- state — промежуточные точки заказа, которые изменяются в соответствии с обновлением информации о доставке по времени state_datetime;
- shipping_plan_datetime — плановая дата доставки;
- hours_to_plan_shipping — запланированное количество часов на доставку;
- shipping_transfer_description — строка со значениями transfer_type и transfer_model, записанными через :;
- shipping_transfer_rate — процент стоимости доставки для вендора в зависимости от типа и модели доставки, который взимается интернет-магазином для покрытия расходов;
- shipping_country — страна доставки, учитывая описание тарифа для каждой страны;
- shipping_country_base_rate — налог на доставку в страну, который является процентом от стоимости payment_amount;
- vendor_agreement_description  — строка, в которой содержатся данные agreement_id, agreement_number, agreement_rate, agreement_commission, записанные через разделитель «:» (двоеточие без кавычек).

Исходная таблица имеет ряд следующих особенностей: 
 - Порядка 2% заказов исполняется с просрочкой, и это норма для вендоров. Вендор №3, у которого этот процент достигает 10%, скорее всего неблагонадёжен;
 - Около 2% заказов не доходят до клиентов;
 - В пределах нормы и то, что порядка 1.5% заказов возвращаются клиентами. При этом у вендора №21 50% возвратов. Он торгует электроникой и ноутбуками — очевидно, в его товарах много брака и стоит его изучить.

Структура построенной витрины: 
- shipping_id — уникальный идентификатор доставки;
- vendor_id — уникальный идентификатор вендора. К одному вендору может быть привязано множество sale_id и множество строк доставки;
- transfer_type — тип доставки из таблицы shipping_transfer;
- full_day_at_shipping — количество полных дней, в течение которых длилась доставка;
- is_delay — статус, показывающий просрочена ли доставка;
- is_shipping_finish — статус, показывающий, что доставка завершена. Если финальный status = finished; 
- delay_day_at_shipping — количество дней, на которые была просрочена доставка;
- payment_amount — сумма платежа пользователя;
- vat — итоговый налог на доставку;
- profit — итоговый доход компании с доставки;

## План работы. 

На основании полученной таблицы необходимо создать 5 справочников и далее на основании их собрать представление. 

1) Создадим справочник стоимости доставки в страны shipping_country_rates из данных, указанных в shipping_country и shipping_country_base_rate. Назначим первичным ключом таблицы — серийный id, то есть серийный идентификатор каждой строчки. Стоит отметить, что важно дать серийному ключу имя «id». Справочник должен состоять из уникальных пар полей из таблицы shipping;

2) Создадим справочник тарифов доставки вендора по договору shipping_agreement из данных строки vendor_agreement_description через разделитель «:» (двоеточие без кавычек);
- Названия полей:
    - agreement_id,
    - agreement_number,
    - agreement_rate,
    - agreement_commission
  
3) Создадим справочник о типах доставки shipping_transfer из строки shipping_transfer_description через разделитель «:» (двоеточие без кавычек);
- Названия полей:
    - transfer_type,
    - transfer_model,
    - shipping_transfer_rate

4) Создадим таблицу shipping_info, справочник комиссий по странам, с уникальными доставками shipping_id и свяжем ее с созданными справочниками shipping_country_rates, shipping_agreement, shipping_transfer и константной информации о доставке shipping_plan_datetime, payment_amount, vendor_id;
   
5) Создадим таблицу статусов о доставке shipping_status и включите туда информацию из лога shipping (status , state). Добавьте туда вычислимую информацию по фактическому времени доставки shipping_start_fact_datetime, shipping_end_fact_datetime . Отразите для каждого уникального shipping_id его итоговое состояние доставки;

6) Создайте представление shipping_datamart описанное нами ранее на основании готовых таблиц для аналитики.

Теперь, когда требования понятны, а исходные данные изучены, можно приступить к реализации.